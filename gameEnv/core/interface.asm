; --------------------------------------------
; Title:   GUI manager
; Author:  Liraal
; Date:    2012-06-30
; Version: 0x1
; --------------------------------------------

:GUI_in_menu	dat 0x0
:GUI_menu_pos 	dat 0x0
:GUI_can_write	dat 0x0
:GUI_pos		dat GUI_main_menu
:GUI_board_x	dat 0x0
:GUI_board_y	dat 0x0
:GUI_player		dat 0x0
:GUI_player0	dat 0xF000
:GUI_player1	dat 0xC000
:GUI_cursor		dat 0x0
:GUI_unit 		dat 0xFFFF
:GUI_city		dat 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff
dat 0x0

:GUI_main_menu
set [GUI_pos], GUI_main_menu
set push, a
set push, b
set [GUI_in_menu], 0x1
set a, GUI_loreM
set b, [GUI_menu_pos]
jsr display_menu
ife [GUI_menu_pos], 0x0
	set a, GUI_loreT
ife [GUI_menu_pos], 0x1
	set a, GUI_nextT
jsr display_menu_content
set b, pop
set a, pop
set pc, pop

:GUI_step
	ife [GUI_pos], GUI_main_menu
		ife [GUI_menu_pos], 0x1
			jsr GUI_board_set
		ife [GUI_in_menu], 0x4
			jsr GUI_unit_opt
		ife [GUI_in_menu], 0x5
			jsr GUI_city_opt
		ife [GUI_in_menu], 0x7
			jsr GUI_build_opt
		ife [GUI_in_menu], 0x8
			jsr GUI_recruit_opt
set pc, pop

:GUI_unit_opt
	ife [GUI_unit], 0x0
		jsr GUI_unit_opt_settler
	ife [GUI_unit], 0x1
		jsr GUI_unit_opt_swordsman
set pc, pop

:GUI_city_opt
	;ife [GUI_city], 0x0
		jsr GUI_city_opt_blank
set pc, pop

:GUI_city_opt_blank
	ife [GUI_menu_pos], 0x1
		int 0x101
	ife [GUI_menu_pos], 0x2
		jsr city_remove
	ife [GUI_menu_pos], 0x3
		int 0x100
	ifn [GUI_menu_pos], 0x3
		jsr GUI_board_set
set pc, pop

:GUI_unit_opt_swordsman
	ife [GUI_menu_pos], 0x1
		jsr GUI_unit_opt_settler_if
	ife [GUI_menu_pos], 0x2
		jsr unit_remove
	ife [GUI_menu_pos], 0x3
		jsr GUI_unit_opt_settler_if2
	ifn [GUI_in_menu], 0x3
		ifn [GUI_in_menu], 0x6
			jsr GUI_board_set
set pc, pop

:GUI_unit_opt_settler
	ife [GUI_menu_pos], 0x1
		jsr GUI_unit_opt_settler_if
	ife [GUI_menu_pos], 0x2
		jsr city_found
	ife [GUI_menu_pos], 0x3
		jsr unit_remove
	ife [GUI_menu_pos], 0x4
		jsr GUI_unit_opt_settler_if2
	ifn [GUI_in_menu], 0x3
		ifn [GUI_in_menu], 0x6
			jsr GUI_board_set
set pc, pop

:GUI_unit_opt_settler_if
	set [GUI_pos], GUI_board
	set [GUI_menu_pos], 0x0
	set [GUI_in_menu], 0x3
	jsr GUI_board
set pc, pop

:GUI_unit_opt_settler_if2
	set [GUI_pos], GUI_board
	set [GUI_menu_pos], 0x0
	set [GUI_in_menu], 0x6
	jsr GUI_board
set pc, pop

:GUI_build_opt
	ife [GUI_menu_pos], 0x1
		jsr city_build_townhall
	ife [GUI_menu_pos], 0x2
		jsr city_build_barracks
;	ife [GUI_menu_pos], 0x3
;		jsr unit_remove
;	ife [GUI_menu_pos], 0x4
;		jsr GUI_unit_opt_settler_if2
	;set [GUI_in_menu], 0x3
	jsr GUI_city_menu_set
set pc, pop

:GUI_recruit_opt
	ife [GUI_menu_pos], 0x1
		jsr city_recruit_settler
	ife [GUI_menu_pos], 0x2
		jsr city_recruit_swordsman
	jsr GUI_city_menu_set
set pc, pop

:GUI_board_set
	set [GUI_pos], GUI_board
	set [GUI_menu_pos], 0x0
	set [GUI_in_menu], 0x2
	;jsr display_set_board
	;jsr GUI_cursor_toggle
	jsr GUI_board
set pc, pop

:GUI_board
	jsr display_set_board
	jsr city_add_to_map
	jsr unit_add_to_map
;	ife [GUI_player], 0x1
;		jsr printT
set pc, pop

:GUI_cursor_toggle
	set push, a
	set push, b
	set a, [GUI_board_y]
	mul a, 0x20
	add a, [GUI_board_x]
	add a, map_tile_entries
	;ifn [GUI_cursor], 0x0
	;	set pc, GUI_cursor_toggle_if
;	set [GUI_cursor], [a]
	;set [GUI_cursor], 0x1
	set b, [a]
	and b, 0x7F
	and [a], 0xF80
	xor [a], 0x80
	ife b, 0x20
		bor [a], 0x5f
	ife b, 0x5f
		bor [a], 0x20
	ifn b, 0x20
		ifn b, 0x5f
			bor [a], b
		;jsr GUI_cursor_toggle_if_2
	ife [GUI_player], 0x0
		ife b, 0x5f
			bor [a], [GUI_player0]
	ife [GUI_player], 0x1
		ife b, 0x5f
			bor [a], [GUI_player1]
	set b, pop
	set a, pop
set pc, pop

;:GUI_cursor_toggle_if
;set [a], [GUI_cursor]
;set [GUI_cursor], 0x0
;set b, pop
;set a, pop
;set pc, pop

:GUI_cursor_toggle_if_2
set b, [a]
and b, 0xFF80
set [a], 0x5f
bor [a], b
set pc, pop

:GUI_cursor_up
	jsr GUI_menu_pos_up
	jsr GUI_cursor_toggle
	ifg [GUI_board_y], 0x0
		sub [GUI_board_y], 1
set pc, pop

:GUI_cursor_down
	jsr GUI_menu_pos_down
	jsr GUI_cursor_toggle
	ifl [GUI_board_y], 0xB
		add [GUI_board_y], 1
set pc, pop

:GUI_cursor_left
	jsr GUI_cursor_toggle
	ifg [GUI_board_x], 0x0
		sub [GUI_board_x], 1
set pc, pop

:GUI_cursor_right
	jsr GUI_cursor_toggle
	ifl [GUI_board_x], 0x1F
		add [GUI_board_x], 1
set pc, pop

:GUI_arrow
	ife [GUI_in_menu], 0x3
		set pc, unit_move
	ife [GUI_in_menu], 0x6
		set pc, unit_attack	
	ifn [GUI_in_menu], 0x2
		set pc, GUI_menu_move
	ife a, 0x10
		jsr GUI_cursor_up
	ife a, 0x11
		jsr GUI_cursor_down
	ife a, 0x12
		jsr GUI_cursor_left
	ife a, 0x13
		jsr GUI_cursor_right
	jsr GUI_cursor_toggle
	jsr GUI_board
set pc, pop

:GUI_menu_move
	ife a, 0x10
		jsr GUI_menu_pos_up
	ife a, 0x11
		jsr GUI_menu_pos_down
set pc, pop

:GUI_menu_pos_up
	ifg [GUI_menu_pos], 0x0
		sub [GUI_menu_pos], 1
	jsr [GUI_pos]
set pc, pop

:GUI_menu_pos_down
	ifl [GUI_menu_pos], 0xB
		add [GUI_menu_pos], 1
	jsr [GUI_pos]
set pc, pop

:GUI_unit_menu_set
set [GUI_pos], GUI_unit_menu
set [GUI_in_menu], 0x4
set [GUI_menu_pos], 0x0
set pc, GUI_unit_menu


:GUI_unit_menu
jsr unit_get_unit
ife [GUI_unit], 0xFFFF
	jsr GUI_back_to_board
set push, a
set push, b
jsr GUI_unit_name
;set a, GUI_nameS
set b, [GUI_menu_pos]
jsr display_menu
;ife [GUI_menu_pos], 0x0
;	jsr GUI_unit_description
;set a, GUI_descS
;ife [GUI_menu_pos], 0x1
;	jsr GUI_unit_movement
;set a, GUI_moveS
;jsr display_menu_content
set b, pop
set a, pop
set pc, pop

:GUI_unit_name
	ife [GUI_unit], 0x0
		set a, GUI_nameS
	ife [GUI_unit], 0x1
		set a, GUI_nameSw
set pc, pop

:GUI_unit_description
	ife [GUI_unit], 0x0
		set a, GUI_descS
	ife [GUI_unit], 0x1
		set a, GUI_descS
set pc, pop

:GUI_unit_movement
	ife [GUI_unit], 0x0
		set a, GUI_moveS
	ife [GUI_unit], 0x1
		set a, GUI_moveS
set pc, pop

:GUI_city_menu_set
set [GUI_pos], GUI_city_menu
set [GUI_in_menu], 0x5
set [GUI_menu_pos], 0x0
set pc, GUI_city_menu

:GUI_city_menu
jsr city_get_city
ife [GUI_city], 0xFFFF
	jsr GUI_back_to_board
set push, a
set push, b
set a, GUI_cityM
set b, [GUI_menu_pos]
jsr display_menu
;ife [GUI_menu_pos], 0x0
;	jsr GUI_city_description
;ife [GUI_menu_pos], 0x1
;	jsr GUI_city_recruitment
;jsr display_menu_content
set b, pop
set a, pop
set pc, pop

:GUI_city_nameM
	set a, GUI_name_string
set pc, pop

:GUI_city_description
	set a, GUI_city
	;add a, 1
set pc, pop

:GUI_city_recruitment
	set a, GUI_city
set pc, pop

:GUI_back_to_board
	set [GUI_pos], GUI_board
	set [GUI_menu_pos], 0x0
	set [GUI_in_menu], 0x2
	set ex, pop
set pc, pop

:GUI_build_menu_set
set [GUI_pos], GUI_build_menu
set [GUI_in_menu], 0x7
set [GUI_menu_pos], 0x0
set pc, GUI_build_menu

:GUI_build_menu
ife [GUI_city], 0xFFFF
	jsr GUI_back_to_board
set push, a
set push, b
set a, GUI_buildM
set b, [GUI_menu_pos]
jsr display_menu
;ife [GUI_menu_pos], 0x0
;	jsr GUI_build_townhall
;ife [GUI_menu_pos], 0x1
;	jsr GUI_build_townhall 
;ife [GUI_menu_pos], 0x2
;	jsr GUI_build_barracks
set b, pop
set a, pop
set pc, pop

:GUI_build_townhall
set a, GUI_build_townhallT
jsr display_menu_content
set pc, pop

:GUI_build_barracks
set a, GUI_build_barracksT
jsr display_menu_content
set pc, pop

:GUI_recruit_menu_set
set [GUI_pos], GUI_recruit_menu
set [GUI_in_menu], 0x8
set [GUI_menu_pos], 0x0
set pc, GUI_recruit_menu

:GUI_recruit_menu
ife [GUI_city], 0xFFFF
	jsr GUI_back_to_board
set push, a
set push, b
set a, GUI_recruitM
set b, [GUI_menu_pos]
jsr display_menu
;ife [GUI_menu_pos], 0x0
;	jsr GUI_build_townhall
;ife [GUI_menu_pos], 0x1
;	jsr GUI_build_townhall 
;ife [GUI_menu_pos], 0x2
;	jsr GUI_build_barracks
set b, pop
set a, pop
set pc, pop

:GUI_loreM	dat 0x4C,0x6F,0x72,0x65,0x20,0x20,0x20,0x20
			dat 0x4E,0x65,0x78,0x74,0x20,0x20,0x20,0x20
dat 0x0
:GUI_loreT	dat 0x47, 0x61, 0x6d, 0x65, 0x20, 0x73, 0x65, 0x74, 0x20, 0x69, 0x6e, 0x20, 0x65, 0x61, 0x72, 0x6c, 0x79, 0x20, 0x6d, 0x65, 0x64, 0x69, 0x65, 0x76, 0x61, 0x6c, 0x20, 0x74, 0x69, 0x6d, 0x65, 0x73, 0x2e, 0x20, 0x53, 0x74, 0x72, 0x75, 0x67, 0x67, 0x6c, 0x65, 0x20, 0x74, 0x61, 0x6b, 0x65, 0x73, 0x20, 0x70, 0x6c, 0x61, 0x63, 0x65, 0x20, 0x69, 0x6e, 0x20, 0x61, 0x6e, 0x20, 0x69, 0x73, 0x6f, 0x6c, 0x61, 0x74, 0x65, 0x64, 0x20, 0x62, 0x61, 0x73, 0x69, 0x6e, 0x2e, 0x0
:GUI_nextT	dat 0x50, 0x72, 0x65, 0x73, 0x73, 0x20, 0x6d, 0x65
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20, 0x0
:GUI_palette 	dat 0x000, 0xA, 0xA0, 0xAA, 0xA00, 0xA0A, 0xa50, 0xA0, 0xa50, 0x55f, 0x5f5, 0x5ff, 0xf55, 0xf5f, 0xff5, 0xfff
:GUI_nameS	dat 0x53, 0x65, 0x74, 0x74, 0x6C, 0x65, 0x72, 0x20
			dat 0x4D, 0x6F, 0x76, 0x65, 0x20, 0x20, 0x20, 0x20
			dat 0x46,0x6F,0x75,0x6E,0x64,0x20,0x20,0x20
			dat 0x52,0x65,0x6D,0x6F,0x76,0x65,0x20,0x20
			dat 0x41,0x74,0x74,0x61,0x63,0x6B,0x20,0x20
			dat 0x4E,0x65,0x78,0x74,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
:GUI_moveS	dat 0x4D, 0x6F, 0x76, 0x65, 0x20, 0x20, 0x20, 0x20, 0x0
:GUI_descS	dat 0x53, 0x65, 0x74, 0x74, 0x6C, 0x65, 0x72, 0x20, 0x0
:GUI_name_string 	dat 0x4E, 0x61, 0x6D, 0x65, 0x20, 0x20, 0x20, 0x20, 0x0
:GUI_cityM	dat 0x43,0x69,0x74,0x79,0x20,0x20,0x20,0x20	;City
			dat 0x52,0x65,0x63,0x72,0x75,0x69,0x74,0x20	;Recruit
			dat 0x52,0x65,0x6D,0x6F,0x76,0x65,0x20,0x20	;Remove
			dat 0x42,0x75,0x69,0x6C,0x64,0x20,0x20,0x20 ;Build
			dat 0x4E,0x65,0x78,0x74,0x20,0x20,0x20,0x20	;Next
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
:GUI_buildM	dat 0x42,0x75,0x69,0x6C,0x64,0x69,0x6E,0x67 ;Building
			dat 0x54,0x6f,0x77,0x6e,0x68,0x61,0x6c,0x6c	;Townhall
			dat 0x52,0x65,0x63,0x72,0x75,0x69,0x74,0x20	;Barracks
			dat 0x4E,0x65,0x78,0x74,0x20,0x20,0x20,0x20	;Next
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
:GUI_build_townhallT	dat 0x54,0x6f,0x77,0x6e,0x68,0x61,0x6c,0x6c, 0x0
:GUI_build_barracksT	dat 0x52,0x65,0x63,0x72,0x75,0x69,0x74,0x20, 0x0
:GUI_nameSw	dat 0x53, 0x77, 0x6f, 0x72, 0x64, 0x6d, 0x61, 0x6e
			dat 0x4D, 0x6F, 0x76, 0x65, 0x20, 0x20, 0x20, 0x20
			dat 0x52,0x65,0x6D,0x6F,0x76,0x65,0x20,0x20
			dat 0x41,0x74,0x74,0x61,0x63,0x6B,0x20,0x20
			dat 0x4E,0x65,0x78,0x74,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
:GUI_recruitM dat 0x53, 0x65, 0x74, 0x74, 0x6C, 0x65, 0x72, 0x20 ;Building
			dat 0x53, 0x77, 0x6f, 0x72, 0x64, 0x6d, 0x61, 0x6e	;Townhall
			dat 0x4E,0x65,0x78,0x74,0x20,0x20,0x20,0x20	;Barracks
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20	;Next
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20
			dat 0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20